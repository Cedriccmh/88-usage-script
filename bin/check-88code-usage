#!/usr/bin/env node

const fs = require('fs');
const https = require('https');
const http = require('http');
const path = require('path');
const os = require('os');

// ANSI colors
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  dim: '\x1b[2m',
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  white: '\x1b[37m'
};

function colorize(text, color) {
  return `${colors[color]}${text}${colors.reset}`;
}

function log(message, color = 'white') {
  console.log(colorize(message, color));
}

function logError(message) {
  console.error(colorize(`âŒ ${message}`, 'red'));
}

function logSuccess(message) {
  console.log(colorize(`âœ“ ${message}`, 'green'));
}

function logInfo(message) {
  console.log(colorize(`â„¹ ${message}`, 'cyan'));
}

// Read Claude settings
function getClaudeSettings() {
  const settingsPath = path.join(os.homedir(), '.claude', 'settings.json');

  if (!fs.existsSync(settingsPath)) {
    throw new Error(`Claude settings not found at ${settingsPath}`);
  }

  const content = fs.readFileSync(settingsPath, 'utf8');
  const settings = JSON.parse(content);

  if (!settings.env || !settings.env.ANTHROPIC_AUTH_TOKEN) {
    throw new Error('ANTHROPIC_AUTH_TOKEN not found in settings.json');
  }

  const baseUrl = settings.env.ANTHROPIC_BASE_URL || 'https://www.88code.org/api';
  const apiKey = settings.env.ANTHROPIC_AUTH_TOKEN;

  // Determine API type
  const isPackyApi = baseUrl.includes('packyapi.com');
  const is88Code = baseUrl.includes('88code.org');

  if (!isPackyApi && !is88Code) {
    throw new Error(`Unsupported API base URL: ${baseUrl}`);
  }

  return {
    apiKey,
    baseUrl,
    isPackyApi,
    is88Code
  };
}

// Make HTTP request with retry
function makeRequest(url, options, body = null, retries = 3, timeout = 20000) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https') ? https : http;

    const attemptRequest = (attemptsLeft) => {
      const req = protocol.request(url, options, (res) => {
        let data = '';

        res.on('data', (chunk) => {
          data += chunk;
        });

        res.on('end', () => {
          if (res.statusCode >= 200 && res.statusCode < 300) {
            try {
              resolve(JSON.parse(data));
            } catch (e) {
              reject(new Error(`Failed to parse JSON: ${e.message}`));
            }
          } else {
            reject(new Error(`HTTP ${res.statusCode}: ${data}`));
          }
        });
      });

      req.on('error', (err) => {
        if (attemptsLeft > 0) {
          logInfo(`è¯·æ±‚å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•... (å‰©ä½™ ${attemptsLeft} æ¬¡)`);
          setTimeout(() => attemptRequest(attemptsLeft - 1), 1000);
        } else {
          reject(err);
        }
      });

      req.setTimeout(timeout, () => {
        req.destroy();
        if (attemptsLeft > 0) {
          logInfo(`è¯·æ±‚è¶…æ—¶ï¼Œæ­£åœ¨é‡è¯•... (å‰©ä½™ ${attemptsLeft} æ¬¡)`);
          setTimeout(() => attemptRequest(attemptsLeft - 1), 1000);
        } else {
          reject(new Error('Request timeout after all retries'));
        }
      });

      if (body) {
        req.write(body);
      }
      req.end();
    };

    attemptRequest(retries);
  });
}

// Get usage from 88code API
async function get88CodeUsage(apiKey) {
  const url = 'https://www.88code.org/api/usage';
  const body = '{}';

  const options = {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json',
      'Content-Length': Buffer.byteLength(body),
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }
  };

  const response = await makeRequest(url, options, body);

  if (!response.ok) {
    throw new Error(response.msg || 'API request failed');
  }

  return response.data;
}

// Get usage from Packyapi
async function getPackyApiUsage(apiKey) {
  const url = 'https://www.packyapi.com/api/usage/token/';

  const options = {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${apiKey}`
    }
  };

  const response = await makeRequest(url, options);

  if (!response.code) {
    throw new Error(response.message || 'API request failed');
  }

  return response.data;
}

// Get subscription info from 88code API
async function get88CodeSubscription(apiKey) {
  const url = 'https://www.88code.org/api/subscription';
  const body = '{}';

  const options = {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json',
      'Content-Length': Buffer.byteLength(body),
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }
  };

  try {
    const response = await makeRequest(url, options, body);
    return response.ok ? response.data : null;
  } catch (e) {
    return null;
  }
}

// Format bytes
function formatTokens(tokens) {
  if (tokens >= 1000000000) {
    return `${(tokens / 1000000000).toFixed(2)}B`;
  } else if (tokens >= 1000000) {
    return `${(tokens / 1000000).toFixed(2)}M`;
  } else if (tokens >= 1000) {
    return `${(tokens / 1000).toFixed(2)}K`;
  }
  return tokens.toString();
}

// Display 88code usage
function display88CodeUsage(data, subscription) {
  console.log('\n' + colorize('â”'.repeat(60), 'cyan'));
  console.log(colorize('  88code ä¸­è½¬ç«™ç”¨é‡æŸ¥è¯¢', 'bright'));
  console.log(colorize('â”'.repeat(60), 'cyan') + '\n');

  // Calculate usage
  const creditLimit = data.creditLimit || 0;
  const currentCredits = data.currentCredits || 0;
  const usedCredits = creditLimit - currentCredits;
  const percentageUsed = creditLimit > 0 ? (usedCredits / creditLimit * 100) : 0;
  const remainingTokens = Math.max(0, currentCredits * 100);
  const usedTokens = Math.max(0, usedCredits * 100);
  const totalTokens = data.totalTokens || 0;

  // Determine color based on usage percentage
  let usageColor = 'green';
  if (percentageUsed > 80) usageColor = 'red';
  else if (percentageUsed > 50) usageColor = 'yellow';

  // Display key info
  console.log(colorize('  å¯†é’¥ä¿¡æ¯', 'bright'));
  console.log('  ' + 'â”€'.repeat(56));
  console.log(`  å¯†é’¥åç§°:   ${colorize(data.name || 'N/A', 'cyan')}`);
  console.log(`  è®¢é˜…ç±»å‹:   ${colorize(data.subscriptionName || 'N/A', 'yellow')}`);
  console.log(`  æ€»è¯·æ±‚æ•°:   ${colorize((data.totalRequests || 0).toLocaleString(), 'white')}`);
  console.log(`  æ€»æ¶ˆè€—:     ${colorize('$' + (data.totalCost || 0).toFixed(2), 'white')}`);
  console.log();

  // Display usage
  console.log(colorize('  ç”¨é‡ç»Ÿè®¡', 'bright'));
  console.log('  ' + 'â”€'.repeat(56));
  console.log(`  æ€»é¢åº¦:     ${colorize(creditLimit.toFixed(2) + ' ç¾å…ƒ', 'cyan')}`);
  console.log(`  å·²ä½¿ç”¨:     ${colorize(usedCredits.toFixed(2) + ' ç¾å…ƒ', usageColor)} (${colorize(percentageUsed.toFixed(1) + '%', usageColor)})`);
  console.log(`  å‰©ä½™é¢åº¦:   ${colorize(currentCredits.toFixed(2) + ' ç¾å…ƒ', 'green')}`);
  console.log(`  æ€» tokens:  ${colorize(formatTokens(totalTokens), 'white')}`);
  console.log(`  å·²ç”¨ tokens: ${colorize(formatTokens(usedTokens), usageColor)}`);
  console.log(`  å‰©ä½™ tokens: ${colorize(formatTokens(remainingTokens), 'green')}`);

  // Progress bar
  const barWidth = 40;
  const filledWidth = Math.round((percentageUsed / 100) * barWidth);
  const emptyWidth = barWidth - filledWidth;
  const bar = 'â–ˆ'.repeat(filledWidth) + 'â–‘'.repeat(emptyWidth);
  console.log(`\n  [${colorize(bar, usageColor)}] ${colorize(percentageUsed.toFixed(1) + '%', usageColor)}\n`);

  // Display subscription from subscriptionEntityList
  const subscriptionList = data.subscriptionEntityList || subscription;
  if (subscriptionList && Array.isArray(subscriptionList) && subscriptionList.length > 0) {
    console.log(colorize('  è®¢é˜…è¯¦æƒ…', 'bright'));
    console.log('  ' + 'â”€'.repeat(56));

    subscriptionList.forEach((sub, index) => {
      if (index > 0) console.log();
      console.log(`  [${index + 1}] ${colorize(sub.subscriptionName || 'N/A', 'cyan')}`);
      console.log(`  ä»·æ ¼:       ${colorize('Â¥' + (sub.cost || 0) + '/' + (sub.billingCycle || 'æœˆ'), 'yellow')}`);
      console.log(`  çŠ¶æ€:       ${colorize(sub.isActive ? 'âœ“ æ´»è·ƒ' : 'âœ— æœªæ¿€æ´»', sub.isActive ? 'green' : 'red')}`);
      console.log(`  å¼€å§‹æ—¶é—´:   ${colorize(sub.startDate || 'N/A', 'white')}`);
      console.log(`  åˆ°æœŸæ—¶é—´:   ${colorize(sub.endDate || 'N/A', 'white')}`);
      console.log(`  å½“å‰é¢åº¦:   ${colorize('$' + (sub.currentCredits || 0).toFixed(2), 'green')}`);
      console.log(`  é¢åº¦ä¸Šé™:   ${colorize('$' + (sub.creditLimit || 0).toFixed(2), 'cyan')}`);
      if (sub.features) {
        console.log(`  åŠŸèƒ½ç‰¹æ€§:   ${colorize(sub.features.split('\n')[0], 'dim')}`);
      }
    });
    console.log();
  }

  console.log(colorize('â”'.repeat(60), 'cyan') + '\n');
}

// Display Packyapi usage
function displayPackyApiUsage(data) {
  console.log('\n' + colorize('â”'.repeat(60), 'cyan'));
  console.log(colorize('  Packyapi ä¸­è½¬ç«™ç”¨é‡æŸ¥è¯¢', 'bright'));
  console.log(colorize('â”'.repeat(60), 'cyan') + '\n');

  const totalGranted = data.total_granted || 0;
  const totalUsed = data.total_used || 0;
  const totalAvailable = data.total_available || 0;
  const percentageUsed = totalGranted > 0 ? (totalUsed / totalGranted * 100) : 0;

  let usageColor = 'green';
  if (percentageUsed > 80) usageColor = 'red';
  else if (percentageUsed > 50) usageColor = 'yellow';

  console.log(colorize('  ç”¨é‡ç»Ÿè®¡', 'bright'));
  console.log('  ' + 'â”€'.repeat(56));
  console.log(`  å¥—é¤åç§°:   ${colorize(data.name || 'N/A', 'cyan')}`);
  console.log(`  æ€»é…é¢:     ${colorize(formatTokens(totalGranted) + ' tokens', 'cyan')}`);
  console.log(`  å·²ä½¿ç”¨:     ${colorize(formatTokens(totalUsed) + ' tokens', usageColor)} (${colorize(percentageUsed.toFixed(1) + '%', usageColor)})`);
  console.log(`  å‰©ä½™é…é¢:   ${colorize(formatTokens(totalAvailable - totalUsed) + ' tokens', 'green')}`);

  if (data.expires_at) {
    const expiryDate = new Date(data.expires_at * 1000);
    console.log(`  åˆ°æœŸæ—¶é—´:   ${colorize(expiryDate.toLocaleString(), 'white')}`);
  }

  const barWidth = 40;
  const filledWidth = Math.round((percentageUsed / 100) * barWidth);
  const emptyWidth = barWidth - filledWidth;
  const bar = 'â–ˆ'.repeat(filledWidth) + 'â–‘'.repeat(emptyWidth);
  console.log(`\n  [${colorize(bar, usageColor)}] ${colorize(percentageUsed.toFixed(1) + '%', usageColor)}\n`);

  console.log(colorize('â”'.repeat(60), 'cyan') + '\n');
}

// Show help
function showHelp() {
  console.log(`
${colorize('88code ä¸­è½¬ç«™ç”¨é‡æŸ¥è¯¢å·¥å…· v1.0', 'bright')}

${colorize('ç”¨æ³•:', 'cyan')}
  check-88code-usage [é€‰é¡¹]
  88usage [é€‰é¡¹]

${colorize('é€‰é¡¹:', 'cyan')}
  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
  -v, --version  æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
  --no-retry     ç¦ç”¨è‡ªåŠ¨é‡è¯•æœºåˆ¶

${colorize('æè¿°:', 'cyan')}
  ä» ~/.claude/settings.json è¯»å–é…ç½®å¹¶æŸ¥è¯¢ 88code/Packyapi ä¸­è½¬ç«™çš„ç”¨é‡ä¿¡æ¯

${colorize('é…ç½®æ–‡ä»¶:', 'cyan')}
  ~/.claude/settings.json

${colorize('æ”¯æŒçš„ä¸­è½¬ç«™:', 'cyan')}
  - 88code.org
  - packyapi.com

${colorize('ç¤ºä¾‹:', 'cyan')}
  88usage              # æŸ¥è¯¢ç”¨é‡
  88usage --help       # æ˜¾ç¤ºå¸®åŠ©
  88usage --no-retry   # ç¦ç”¨é‡è¯•
`);
}

// Main function
async function main() {
  // Parse arguments
  const args = process.argv.slice(2);

  if (args.includes('-h') || args.includes('--help')) {
    showHelp();
    process.exit(0);
  }

  if (args.includes('-v') || args.includes('--version')) {
    console.log('v1.0.0');
    process.exit(0);
  }

  try {
    logInfo('æ­£åœ¨è¯»å– Claude é…ç½®...');
    const settings = getClaudeSettings();

    logInfo(`æ£€æµ‹åˆ° API ç±»å‹: ${settings.is88Code ? '88code' : 'Packyapi'}`);
    logInfo('æ­£åœ¨æŸ¥è¯¢ç”¨é‡ä¿¡æ¯...\n');

    if (settings.is88Code) {
      const [usage, subscription] = await Promise.all([
        get88CodeUsage(settings.apiKey),
        get88CodeSubscription(settings.apiKey)
      ]);
      display88CodeUsage(usage, subscription);
    } else if (settings.isPackyApi) {
      const usage = await getPackyApiUsage(settings.apiKey);
      displayPackyApiUsage(usage);
    }

    logSuccess('æŸ¥è¯¢å®Œæˆï¼');
    process.exit(0);
  } catch (error) {
    logError(`é”™è¯¯: ${error.message}`);
    if (error.message.includes('timeout')) {
      console.log('\n' + colorize('ğŸ’¡ æç¤º:', 'yellow'));
      console.log('  ç½‘ç»œè¿æ¥ä¼¼ä¹è¾ƒæ…¢ï¼Œè¯·ç¨åé‡è¯•');
      console.log('  å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
    process.exit(1);
  }
}

// Run
main();
